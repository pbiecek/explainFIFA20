---
title: "Predictive model for FIFA 20"
output: 
  html_document:
    toc: true
---

# Read data

Read the data from the kaggle website https://www.kaggle.com/stefanoleone992/fifa-20-complete-player-dataset.

```{r warning=FALSE, message=FALSE}
library("readr")
fifa20 <- as.data.frame(read_csv("players_20.csv"))
```

# Feature selection

Let's select only features related to player characteristics.

```{r warning=FALSE, message=FALSE}
fifa20_selected <- fifa20[,c(4,5,7,8,11:13,17,25:26,45:78)]
```

# Feature engineering

Value is skewed. Will be much easier to model sqrt(Value).

```{r warning=FALSE, message=FALSE}
fifa20_selected$value_eur <- log10(fifa20_selected$value_eur)

fifa20_selected$team_position <- factor(fifa20_selected$team_position)

fifa20_selected <- na.omit(fifa20_selected)
fifa20_selected <- fifa20_selected[fifa20_selected$value_eur > 0,]
fifa20_selected <- fifa20_selected[!duplicated(fifa20_selected[,1]),]
rownames(fifa20_selected) <- fifa20_selected[,1]
fifa20_selected <- fifa20_selected[,-1]
```

# Create a gbm model

Let's use `gbm` library to create a `gbm` model with 250 trees 3 levels deep.

```{r warning=FALSE, message=FALSE}
set.seed(1313)

library("gbm")
# 4:5 are overall and potential, too strong predictors
fifa_gbm <- gbm(value_eur ~ . , data = fifa20_selected[,-(4:5)], n.trees = 250, interaction.depth = 3)
```

# Create a DALEX explainer

Let's wrap gbm model into a DALEX explainer.

```{r warning=FALSE, message=FALSE}
library("DALEX")

fifa_gbm_exp <- explain(fifa_gbm, 
                        data = fifa20_selected[, -6], 
                        y = 10^fifa20_selected$value_eur, 
                        predict_function = function(m,x) 
                          10^predict(m, x, n.trees = 250))
```

# Feature Importance explainer

Calculate Feature Importnace explainer.

```{r warning=FALSE, message=FALSE}
library("ingredients")
fifa_feat <- ingredients::feature_importance(fifa_gbm_exp)
plot(fifa_feat, max_vars = 12)
```

# Partial Dependency explainer

Calculate Partial Dependency explainer.

```{r warning=FALSE, message=FALSE}
fifa20_pd <- ingredients::partial_dependency(fifa_gbm_exp, variables = "age")
plot(fifa20_pd)
```

# Ceteris Paribus explainer

Calculate Ceteris Paribus explainer.

```{r warning=FALSE, message=FALSE}
new_observation <- fifa20_selected["Robert Lewandowski",]

fifa20_cp_pg <- ingredients::ceteris_paribus(fifa_gbm_exp, new_observation = new_observation, variables = "age", variable_splits = list(age = seq(18,45,0.1)))
plot(fifa20_cp_pg)
```

# Break Down explainer

Calculate Break Down explainer.

```{r warning=FALSE, message=FALSE}
library("iBreakDown")
fifa_pg_gbm <- break_down(fifa_gbm_exp, new_observation = new_observation)
plot(fifa_pg_gbm, max_features = 10)

fifa_pg_gbm$label = "Break Down for Robert Lewandowski (GBM model)"

library("ggplot2")
library("scales")
plot(fifa_pg_gbm, digits = 0, max_features = 10) +  
  scale_y_continuous(labels = dollar_format(suffix = "€", prefix = ""), name = "Estimated value", limits = 1000000*c(1,100), breaks = 1000000*c(1,25,50,75,100))


fifa_pg_gbm <- shap(fifa_gbm_exp, new_observation = new_observation)
plot(fifa_pg_gbm, max_features = 10)


```

# modelStudio app

Calculate modelStudio dashboard.

```{r eval = FALSE}
library("modelStudio")

# Use parallelMap to speed up the computation
options(
    parallelMap.default.mode        = "socket",
    parallelMap.default.cpus        = 4,
    parallelMap.default.show.info   = FALSE
)

# Subset the data for better performance
set.seed(123)
index_10k <- sample(nrow(fifa20_selected), nrow(fifa20_selected)/2)
fifa_gbm_exp_10k <- DALEX::update_data(fifa_gbm_exp,
                                       data = fifa20_selected[index_10k, -6],
                                       y = 10^fifa20_selected$value_eur[index_10k])

# Pick observations
fifa_selected_40 <- fifa20_selected[c(1:40, 61), ]

# Make a studio for the model
fifa20_ms <- modelStudio(
                fifa_gbm_exp_10k, 
                new_observation = fifa_selected_40,
                B = 10, N = 400,
                parallel = TRUE, show_info = FALSE,
                rounding_function = signif, digits = 5,
                options = modelStudioOptions(
                    #show_boxplot = FALSE,
                    margin_left = 175,
                    margin_ytitle = 110,
                    ms_title = "Interactive Model Studio for ⚽⚽⚽ FIFA 20 ⚽⚽⚽ (GBM model)"
                ))

fifa20_ms

# Save as HTML
r2d3::save_d3_html(fifa20_ms, file = "fifa20_ms.html")

```

